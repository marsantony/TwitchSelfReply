<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <title>Twitch自動回覆</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://marsantony.github.io/">Mars Liu</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/TwitchSelfReply">Twitch自動回覆(用自己的帳號)</a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            蝦愛橘子相關
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="/Twitch_AutoGameStatusUpdate">!遊戲指令更新</a></li>
                            <li><a class="dropdown-item" href="/Youtube_AutoVideosUpdate">!YT指令更新</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="mx-auto col-10 col-md-8 col-lg-6">
        <br />
        <br />
        <div class="form-group">
            <label for="username">使用者帳號</label>
            <input type="text" id="username" class="form-control" />
        </div>
        <div class="form-group">
            <label for="password">OAuth密碼</label>
            <a href="https://twitchapps.com/tmi/" class="link-info" target="_blank">Twitch取得oath password</a>
            <input type="password" id="password" class="form-control" />
        </div>

        <!--<div class="form-group">
        <label for="azureFunctionKey">Azure Function Key</label>
        <input type="text" id="azureFunctionKey" class="form-control" />
    </div>-->

        <div class="form-group">
            <label for="gameName">自訂遊戲名稱</label>
            <input type="text" id="gameName" class="form-control" />
        </div>

        <div class="form-group">
            <label for="commandReplyTemplate">!遊戲指令Template(MOD)</label>
            <input type="text" id="commandReplyTemplate" class="form-control" />
        </div>

        <br />
        <div class="form-group" style="text-align:right;">
            <input type="button" id="immediatelyReplyMOD" class="btn btn-success" value="立即回覆並更新(MOD)" />
            <input type="button" id="autoReplyMOD" class="btn btn-success" value="開始自動回覆並更新(MOD)" />
            <input type="button" id="startReplyMOD" class="btn btn-success" value="開始自動回覆並更新(MOD)" style="display:none;" />
            <input type="button" id="stopReplyMOD" class="btn btn-danger" value="停止回覆(MOD)" style="display:none;" />

            <input type="button" id="autoReply" class="btn btn-primary" value="開始自動回覆" />

            <input type="button" id="startReply" class="btn btn-primary" value="開始自動回覆" style="display:none;" />
            <input type="button" id="stopReply" class="btn btn-danger" value="停止回覆" style="display:none;" />

        </div>


        <div class="form-group">
            <label for="currentSteamGameName">steam抓到的目前遊戲名稱：</label>
            <span id="currentSteamGameName"></span>
        </div>

        <div class="form-group">
            <label for="currentCommandReplyGameName">上一個遊戲指令的遊戲名稱：</label>
            <span id="currentCommandReplyGameName"></span>
        </div>
        <div class="form-group">
            <label for="log">回覆的LOG：</label>
            <textarea id="log" class="form-control" rows="10" style="resize: none;" readonly></textarea>
        </div>
    </div>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>

    <script>
        const LOCALSTORAGE_USERNAME = 'TwitchAutoReply_UserName';
        const LOCALSTORAGE_PASSWORD = 'TwitchAutoReply_Password';
        const LOCALSTORAGE_COMMANDREPLYTEMPLATE = 'TwitchAutoReply_CommandReplyTemplate';
        //const LOCALSTORAGE_AZUREFUNCTIONKEY = 'TwitchAutoReply_AzureFunctionKey';

        //將預設值帶入
        document.getElementById('username').value = localStorage.getItem(LOCALSTORAGE_USERNAME) || '';
        document.getElementById('password').value = localStorage.getItem(LOCALSTORAGE_PASSWORD) || '';
        document.getElementById('commandReplyTemplate').value = localStorage.getItem(LOCALSTORAGE_COMMANDREPLYTEMPLATE) || '';
        //document.getElementById('azureFunctionKey').value = localStorage.getItem(LOCALSTORAGE_AZUREFUNCTIONKEY) || '';

        class selfReplyClass {
            #isEnable = false;
            #currentGameName = '';
            #replyGameName = '';
            //這邊只允許一個channel連接
            #channels = ['marsantonymars']; //shuteye_orange
            #client;
            constructor(options) {
                if (!options || !options.firstButtonName ||
                    !options.startButtonName || !options.stopButtonName ||
                    !options.getMessage || typeof options.getMessage !== 'function') {
                    return;
                }

                this.firstButtonName = options.firstButtonName;
                this.startButtonName = options.startButtonName;
                this.stopButtonName = options.stopButtonName;
                this.getMessage = options.getMessage;

                this.immediatelyButtonName = options.immediatelyButtonName;
                this.commandName = options.commandName || '遊戲';
            }

            #connect() {
                this.#client = new tmi.Client({
                    options: {
                        debug: false,
                        skipMembership: true, // 不接收 JOIN/PART 訊息
                        skipUpdatingEmotesets: true,
                    },
                    connection: {
                        reconnect: true,
                        secure: true
                    },
                    identity: {
                        username: document.getElementById('username').value,            // [TODO]: input your Twitch username
                        password: document.getElementById('password').value        // [TODO]: input the genereated oath password
                        // 1. go to https://twitchapps.com/tmi/
                        // 2. click "Connect"
                        // 3. You will get a password beginning with "oath..."
                        // 4. Copy the whole password and paste inside the 'genereated_oath_password'
                    },
                    channels: this.#channels // [TODO]: input the channel name you want to listen to
                });

                //成功連接
                this.#client.connect().catch(console.error);
            }

            init() {

                if (this.immediatelyButtonName) {
                    document.getElementById(this.immediatelyButtonName).addEventListener('click', (e) => {

                        if (!this.#client)
                            this.#connect();

                        
                        fetch(`https://asia-east1-steamwebapi-394409.cloudfunctions.net/GetOrangeSteamStatus`)
                            .then((response) => {
                                console.log(response);
                                return response.json();
                            }).then((json) => {
                                console.log(json);
                                document.getElementById('currentSteamGameName').innerHTML = json['GameName'];
                                //清空
                                this.#currentGameName = '';
                                //自訂遊戲名稱優先權較高
                                this.#currentGameName = document.getElementById('gameName').value || json['GameName'];

                                if (this.#currentGameName && this.#currentGameName !== this.#replyGameName) {
                                    const replyMessage = this.getMessage(this.#currentGameName);
                                    this.#client.say(this.#channels[0], replyMessage);
                                    //client.reply(channel, replyMessage, tags ); v1.9.0-pre.1

                                    var name = '點擊立即回覆並更新(MOD)';
                                    var timeStamp = new Date().toLocaleString('sv-SE');
                                    document.getElementById('log').innerHTML = `${timeStamp} ${name} ，回覆：${replyMessage}\r\n${document.getElementById('log').innerHTML}`;
                                }
                            });
                    });
                }

                document.getElementById(this.firstButtonName).addEventListener('click', (e) => {

                    if (!this.#client)
                        this.#connect();

                    //將預設值寫入localStorage
                    localStorage.setItem(LOCALSTORAGE_USERNAME, document.getElementById('username').value);
                    localStorage.setItem(LOCALSTORAGE_PASSWORD, document.getElementById('password').value);
                    localStorage.setItem(LOCALSTORAGE_COMMANDREPLYTEMPLATE, document.getElementById('commandReplyTemplate').value);
                    //localStorage.setItem(LOCALSTORAGE_AZUREFUNCTIONKEY, document.getElementById('azureFunctionKey').value);


                    this.#client.on('message', (channel, tags, message, self) => {
                        //不知為啥streamelements的username小寫= =
                        if (tags.username.toLowerCase() === 'streamelements' && message.includes('遊戲名稱(Game Title)')) {
                            this.#replyGameName = /『(.+)』/gm.exec(message)[1].trim();
                            document.getElementById('currentCommandReplyGameName').innerHTML = this.#replyGameName;
                        }

                        if (!this.#isEnable) return;

                        if (self || !message.startsWith('!')) return;

                        const args = message.slice(1).split(' ');
                        const command = args.shift().toLowerCase();

                        if (command === this.commandName) {
                            //fetch(`https://getorangesteamstatus.azurewebsites.net/api/Get?code=${document.getElementById('azureFunctionKey').value}`)
                            fetch(`https://asia-east1-steamwebapi-394409.cloudfunctions.net/GetOrangeSteamStatus`)
                                .then((response) => {
                                    console.log(response);
                                    return response.json();
                                }).then((json) => {
                                    console.log(json);
                                    document.getElementById('currentSteamGameName').innerHTML = json['GameName'];
                                    //清空
                                    this.#currentGameName = '';
                                    //自訂遊戲名稱優先權較高
                                    this.#currentGameName = document.getElementById('gameName').value || json['GameName'];

                                    if (this.#currentGameName && this.#currentGameName !== this.#replyGameName) {
                                        const replyMessage = this.getMessage(this.#currentGameName);
                                        this.#client.say(channel, replyMessage);
                                        //this.#client.reply(channel, replyMessage, tags ); v1.9.0-pre.1

                                        var name = tags['display-name'] ? `${tags['display-name']}(${tags['username']})` : tags['username'];
                                        var timeStamp = new Date(tags['tmi-sent-ts'] * 1).toLocaleString('sv-SE');
                                        document.getElementById('log').innerHTML = `${timeStamp} ${name} !${this.commandName}，回覆：${replyMessage}\r\n${document.getElementById('log').innerHTML}`;
                                    }
                                });
                        }
                    });

                    document.getElementById(this.startButtonName).click();
                });

                document.getElementById(this.startButtonName).addEventListener('click', (e) => {
                    this.#isEnable = true;

                    document.getElementById(this.firstButtonName).style.display = 'none';
                    document.getElementById(this.startButtonName).style.display = 'none';
                    document.getElementById(this.stopButtonName).style.display = '';
                });

                document.getElementById(this.stopButtonName).addEventListener('click', (e) => {
                    this.#isEnable = false;

                    document.getElementById(this.firstButtonName).style.display = 'none';
                    document.getElementById(this.startButtonName).style.display = '';
                    document.getElementById(this.stopButtonName).style.display = 'none';
                });
            }
        };

       
        new selfReplyClass({
            firstButtonName: 'autoReply',
            startButtonName: 'startReply',
            stopButtonName: 'stopReply',
            getMessage: function (currentGameName) {
                return `MrDestructoid 自動回覆：「目前遊戲名稱：${currentGameName}」`;
            }
        }).init();

        new selfReplyClass({
            firstButtonName: 'autoReplyMOD',
            startButtonName: 'startReplyMOD',
            stopButtonName: 'stopReplyMOD',
            getMessage: function (currentGameName) {
                const fullMessage = document.getElementById('commandReplyTemplate').value.replace(/『(.*)』/gm, `『${currentGameName}』`);
                return `!command edit !遊戲 ${fullMessage}`;
            },

            immediatelyButtonName: 'immediatelyReplyMOD',
            commandName:'更新遊戲',
        }).init();
        
    </script>
</body>

</html>